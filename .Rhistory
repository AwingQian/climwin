BIntNo            <- cutoff.month + 12 * (year(BDate) - min(year(CDate)))
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- cutoff.month + 12 * (year(BDate[wrongyear]) + 1 - min(year(CDate)))
} else {
BIntNo <- RealBIntNo
}
}
}
return(list(CIntNo = CIntNo, BIntNo = BIntNo, Xvar = Xvar, Xvar2 = Xvar2))
}
blob <- DateConverter(BDate = Offspring$Date, CDate = test$Date, Xvar = test$Temp, CINTERVAL = "D", FIXED = FALSE)
blob
DateConverter2 <- function(BDate, CDate, Xvar, Xvar2 = NULL, CINTERVAL, FIXED,
cutoff.day, cutoff.month, cross = FALSE){
BDate  <- as.Date(BDate, format = "%d/%m/%Y") # Convert the date variables into the R date format
CDate2 <- seq(min(as.Date(CDate, format = "%d/%m/%Y")), max(as.Date(CDate, format = "%d/%m/%Y")), "days") # Convert the date variables into the R date format
CDate  <- as.Date(CDate, format = "%d/%m/%Y")
Xvar <- Xvar[match(CDate2, CDate)]
CIntNo     <- as.numeric(Dat2$ListDate) - min(as.numeric(Dat2$ListDate)) + 1   # atrribute daynumbers for both datafiles with first date in CLimateData set to CIntNo 1
RealBIntNo <- as.numeric(BDate) - min(as.numeric(Dat2$ListDate)) + 1
if (length(CIntNo) != length(unique(CIntNo))){
stop ("There are duplicate dayrecords in climate data")
}
if (CINTERVAL != "D" && CINTERVAL != "W" && CINTERVAL != "M"){
stop("CINTERVAL should be either D, W or M")
}
if(cross == FALSE){
if (CINTERVAL == "D"){
if (FIXED == TRUE){
BIntNo            <- as.numeric(as.Date(paste(cutoff.day, cutoff.month, year(BDate), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- (as.numeric(as.Date(paste(cutoff.day, cutoff.month, (year(BDate[wrongyear]) + 1), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1)
} else {
BIntNo <- RealBIntNo
}
} else if (CINTERVAL == "W"){
CIntNo     <- ceiling((as.numeric(CDate) - min(as.numeric(CDate)) + 1) / 7)   # atrribute weeknumbers for both datafiles with first week in CLimateData set to CIntNo 1
RealBIntNo <- ceiling((as.numeric(BDate) - min(as.numeric(CDate)) + 1) / 7)
NewClim    <- data.frame("CIntNo" = CIntNo, "Xvar" = Xvar)
NewClim2   <- melt(NewClim, id = "CIntNo")
NewClim3   <- cast(NewClim2, CIntNo~variable, mean)
CIntNo     <- NewClim3$CIntNo
Xvar       <- NewClim3$Xvar
if (FIXED == TRUE){
BIntNo            <- ceiling((as.numeric(as.Date(paste(cutoff.day, cutoff.month, year(BDate), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1) / 7)
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- ceiling((as.numeric(as.Date(paste(cutoff.day, cutoff.month, (year(BDate[wrongyear]) + 1), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1) / 7)
} else {
BIntNo <- RealBIntNo
}
} else if (CINTERVAL == "M"){
Cmonth     <- month(CDate)
Cyear      <- year(CDate) - min(year(CDate))
CIntNo     <- Cmonth + 12 * Cyear
RealBIntNo <- month(BDate) + 12 * (year(BDate) - min(year(CDate)))
NewClim    <- data.frame("CIntNo" = CIntNo, "Xvar" = Xvar)
NewClim2   <- melt(NewClim, id = "CIntNo")
NewClim3   <- cast(NewClim2, CIntNo~variable, mean)
CIntNo     <- NewClim3$CIntNo
Xvar       <- NewClim3$Xvar
if (FIXED == TRUE){
BIntNo            <- cutoff.month + 12 * (year(BDate) - min(year(CDate)))
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- cutoff.month + 12 * (year(BDate[wrongyear]) + 1 - min(year(CDate)))
} else {
BIntNo <- RealBIntNo
}
}
} else {
if (CINTERVAL == "D"){
if (FIXED == TRUE){
BIntNo            <- as.numeric(as.Date(paste(cutoff.day, cutoff.month, year(BDate), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- (as.numeric(as.Date(paste(cutoff.day, cutoff.month, (year(BDate[wrongyear]) + 1), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1)
} else {
BIntNo <- RealBIntNo
}
} else if (CINTERVAL == "W"){
CIntNo     <- ceiling((as.numeric(CDate) - min(as.numeric(CDate)) + 1) / 7)   # atrribute weeknumbers for both datafiles with first week in CLimateData set to CIntNo 1
RealBIntNo <- ceiling((as.numeric(BDate) - min(as.numeric(CDate)) + 1) / 7)
NewClim    <- data.frame("CIntNo" = CIntNo, "Xvar" = Xvar, "Xvar2" = Xvar2)
NewClim2   <- melt(NewClim, id = "CIntNo")
NewClim3   <- cast(NewClim2, CIntNo~variable, mean)
CIntNo     <- NewClim3$CIntNo
Xvar       <- NewClim3$Xvar
Xvar2      <- NewClim3$Xvar2
if (FIXED == TRUE){
BIntNo            <- ceiling((as.numeric(as.Date(paste(cutoff.day, cutoff.month, year(BDate), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1) / 7)
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- ceiling((as.numeric(as.Date(paste(cutoff.day, cutoff.month, (year(BDate[wrongyear]) + 1), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1) / 7)
} else {
BIntNo <- RealBIntNo
}
} else if (CINTERVAL == "M"){
Cmonth     <- month(CDate)
Cyear      <- year(CDate) - min(year(CDate))
CIntNo     <- Cmonth + 12 * Cyear
RealBIntNo <- month(BDate) + 12 * (year(BDate) - min(year(CDate)))
NewClim    <- data.frame("CIntNo" = CIntNo, "Xvar" = Xvar, "Xvar2" = Xvar2)
NewClim2   <- melt(NewClim, id = "CIntNo")
NewClim3   <- cast(NewClim2, CIntNo ~ variable, mean)
CIntNo     <- NewClim3$CIntNo
Xvar       <- NewClim3$Xvar
Xvar2      <- NewClim3$Xvar2
if (FIXED == TRUE){
BIntNo            <- cutoff.month + 12 * (year(BDate) - min(year(CDate)))
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- cutoff.month + 12 * (year(BDate[wrongyear]) + 1 - min(year(CDate)))
} else {
BIntNo <- RealBIntNo
}
}
}
return(list(CIntNo = CIntNo, BIntNo = BIntNo, Xvar = Xvar, Xvar2 = Xvar2))
}
#Function to convert dates into day/week/month number
DateConverter <- function(BDate, CDate, Xvar, Xvar2 = NULL, CINTERVAL, FIXED,
cutoff.day, cutoff.month, cross = FALSE){
BDate <- as.Date(BDate, format = "%d/%m/%Y") # Convert the date variables into the R date format
CDate <- as.Date(CDate, format = "%d/%m/%Y") # Convert the date variables into the R date format
CIntNo     <- as.numeric(CDate) - min(as.numeric(CDate)) + 1   # atrribute daynumbers for both datafiles with first date in CLimateData set to CIntNo 1
RealBIntNo <- as.numeric(BDate) - min(as.numeric(CDate)) + 1
if (length(CIntNo) != length(unique(CIntNo))){
stop ("There are duplicate dayrecords in climate data")
}
if (CINTERVAL != "D" && CINTERVAL != "W" && CINTERVAL != "M"){
stop("CINTERVAL should be either D, W or M")
}
if(cross == FALSE){
if (CINTERVAL == "D"){
if (FIXED == TRUE){
BIntNo            <- as.numeric(as.Date(paste(cutoff.day, cutoff.month, year(BDate), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- (as.numeric(as.Date(paste(cutoff.day, cutoff.month, (year(BDate[wrongyear]) + 1), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1)
} else {
BIntNo <- RealBIntNo
}
} else if (CINTERVAL == "W"){
CIntNo     <- ceiling((as.numeric(CDate) - min(as.numeric(CDate)) + 1) / 7)   # atrribute weeknumbers for both datafiles with first week in CLimateData set to CIntNo 1
RealBIntNo <- ceiling((as.numeric(BDate) - min(as.numeric(CDate)) + 1) / 7)
NewClim    <- data.frame("CIntNo" = CIntNo, "Xvar" = Xvar)
NewClim2   <- melt(NewClim, id = "CIntNo")
NewClim3   <- cast(NewClim2, CIntNo~variable, mean)
CIntNo     <- NewClim3$CIntNo
Xvar       <- NewClim3$Xvar
if (FIXED == TRUE){
BIntNo            <- ceiling((as.numeric(as.Date(paste(cutoff.day, cutoff.month, year(BDate), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1) / 7)
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- ceiling((as.numeric(as.Date(paste(cutoff.day, cutoff.month, (year(BDate[wrongyear]) + 1), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1) / 7)
} else {
BIntNo <- RealBIntNo
}
} else if (CINTERVAL == "M"){
Cmonth     <- month(CDate)
Cyear      <- year(CDate) - min(year(CDate))
CIntNo     <- Cmonth + 12 * Cyear
RealBIntNo <- month(BDate) + 12 * (year(BDate) - min(year(CDate)))
NewClim    <- data.frame("CIntNo" = CIntNo, "Xvar" = Xvar)
NewClim2   <- melt(NewClim, id = "CIntNo")
NewClim3   <- cast(NewClim2, CIntNo~variable, mean)
CIntNo     <- NewClim3$CIntNo
Xvar       <- NewClim3$Xvar
if (FIXED == TRUE){
BIntNo            <- cutoff.month + 12 * (year(BDate) - min(year(CDate)))
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- cutoff.month + 12 * (year(BDate[wrongyear]) + 1 - min(year(CDate)))
} else {
BIntNo <- RealBIntNo
}
}
} else {
if (CINTERVAL == "D"){
if (FIXED == TRUE){
BIntNo            <- as.numeric(as.Date(paste(cutoff.day, cutoff.month, year(BDate), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- (as.numeric(as.Date(paste(cutoff.day, cutoff.month, (year(BDate[wrongyear]) + 1), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1)
} else {
BIntNo <- RealBIntNo
}
} else if (CINTERVAL == "W"){
CIntNo     <- ceiling((as.numeric(CDate) - min(as.numeric(CDate)) + 1) / 7)   # atrribute weeknumbers for both datafiles with first week in CLimateData set to CIntNo 1
RealBIntNo <- ceiling((as.numeric(BDate) - min(as.numeric(CDate)) + 1) / 7)
NewClim    <- data.frame("CIntNo" = CIntNo, "Xvar" = Xvar, "Xvar2" = Xvar2)
NewClim2   <- melt(NewClim, id = "CIntNo")
NewClim3   <- cast(NewClim2, CIntNo~variable, mean)
CIntNo     <- NewClim3$CIntNo
Xvar       <- NewClim3$Xvar
Xvar2      <- NewClim3$Xvar2
if (FIXED == TRUE){
BIntNo            <- ceiling((as.numeric(as.Date(paste(cutoff.day, cutoff.month, year(BDate), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1) / 7)
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- ceiling((as.numeric(as.Date(paste(cutoff.day, cutoff.month, (year(BDate[wrongyear]) + 1), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1) / 7)
} else {
BIntNo <- RealBIntNo
}
} else if (CINTERVAL == "M"){
Cmonth     <- month(CDate)
Cyear      <- year(CDate) - min(year(CDate))
CIntNo     <- Cmonth + 12 * Cyear
RealBIntNo <- month(BDate) + 12 * (year(BDate) - min(year(CDate)))
NewClim    <- data.frame("CIntNo" = CIntNo, "Xvar" = Xvar, "Xvar2" = Xvar2)
NewClim2   <- melt(NewClim, id = "CIntNo")
NewClim3   <- cast(NewClim2, CIntNo ~ variable, mean)
CIntNo     <- NewClim3$CIntNo
Xvar       <- NewClim3$Xvar
Xvar2      <- NewClim3$Xvar2
if (FIXED == TRUE){
BIntNo            <- cutoff.month + 12 * (year(BDate) - min(year(CDate)))
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- cutoff.month + 12 * (year(BDate[wrongyear]) + 1 - min(year(CDate)))
} else {
BIntNo <- RealBIntNo
}
}
}
return(list(CIntNo = CIntNo, BIntNo = BIntNo, Xvar = Xvar, Xvar2 = Xvar2))
}
#Function to convert dates into day/week/month number
DateConverter <- function(BDate, CDate, Xvar, Xvar2 = NULL, CINTERVAL, FIXED,
cutoff.day, cutoff.month, cross = FALSE){
BDate <- as.Date(BDate, format = "%d/%m/%Y") # Convert the date variables into the R date format
CDate <- as.Date(CDate, format = "%d/%m/%Y") # Convert the date variables into the R date format
CIntNo     <- as.numeric(CDate) - min(as.numeric(CDate)) + 1   # atrribute daynumbers for both datafiles with first date in CLimateData set to CIntNo 1
RealBIntNo <- as.numeric(BDate) - min(as.numeric(CDate)) + 1
if (length(CIntNo) != length(unique(CIntNo))){
stop ("There are duplicate dayrecords in climate data")
}
if (CINTERVAL != "D" && CINTERVAL != "W" && CINTERVAL != "M"){
stop("CINTERVAL should be either D, W or M")
}
if(cross == FALSE){
if (CINTERVAL == "D"){
if (FIXED == TRUE){
BIntNo            <- as.numeric(as.Date(paste(cutoff.day, cutoff.month, year(BDate), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- (as.numeric(as.Date(paste(cutoff.day, cutoff.month, (year(BDate[wrongyear]) + 1), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1)
} else {
BIntNo <- RealBIntNo
}
} else if (CINTERVAL == "W"){
CIntNo     <- ceiling((as.numeric(CDate) - min(as.numeric(CDate)) + 1) / 7)   # atrribute weeknumbers for both datafiles with first week in CLimateData set to CIntNo 1
RealBIntNo <- ceiling((as.numeric(BDate) - min(as.numeric(CDate)) + 1) / 7)
NewClim    <- data.frame("CIntNo" = CIntNo, "Xvar" = Xvar)
NewClim2   <- melt(NewClim, id = "CIntNo")
NewClim3   <- cast(NewClim2, CIntNo~variable, mean)
CIntNo     <- NewClim3$CIntNo
Xvar       <- NewClim3$Xvar
if (FIXED == TRUE){
BIntNo            <- ceiling((as.numeric(as.Date(paste(cutoff.day, cutoff.month, year(BDate), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1) / 7)
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- ceiling((as.numeric(as.Date(paste(cutoff.day, cutoff.month, (year(BDate[wrongyear]) + 1), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1) / 7)
} else {
BIntNo <- RealBIntNo
}
} else if (CINTERVAL == "M"){
Cmonth     <- month(CDate)
Cyear      <- year(CDate) - min(year(CDate))
CIntNo     <- Cmonth + 12 * Cyear
RealBIntNo <- month(BDate) + 12 * (year(BDate) - min(year(CDate)))
NewClim    <- data.frame("CIntNo" = CIntNo, "Xvar" = Xvar)
NewClim2   <- melt(NewClim, id = "CIntNo")
NewClim3   <- cast(NewClim2, CIntNo~variable, mean)
CIntNo     <- NewClim3$CIntNo
Xvar       <- NewClim3$Xvar
if (FIXED == TRUE){
BIntNo            <- cutoff.month + 12 * (year(BDate) - min(year(CDate)))
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- cutoff.month + 12 * (year(BDate[wrongyear]) + 1 - min(year(CDate)))
} else {
BIntNo <- RealBIntNo
}
}
} else {
if (CINTERVAL == "D"){
if (FIXED == TRUE){
BIntNo            <- as.numeric(as.Date(paste(cutoff.day, cutoff.month, year(BDate), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- (as.numeric(as.Date(paste(cutoff.day, cutoff.month, (year(BDate[wrongyear]) + 1), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1)
} else {
BIntNo <- RealBIntNo
}
} else if (CINTERVAL == "W"){
CIntNo     <- ceiling((as.numeric(CDate) - min(as.numeric(CDate)) + 1) / 7)   # atrribute weeknumbers for both datafiles with first week in CLimateData set to CIntNo 1
RealBIntNo <- ceiling((as.numeric(BDate) - min(as.numeric(CDate)) + 1) / 7)
NewClim    <- data.frame("CIntNo" = CIntNo, "Xvar" = Xvar, "Xvar2" = Xvar2)
NewClim2   <- melt(NewClim, id = "CIntNo")
NewClim3   <- cast(NewClim2, CIntNo~variable, mean)
CIntNo     <- NewClim3$CIntNo
Xvar       <- NewClim3$Xvar
Xvar2      <- NewClim3$Xvar2
if (FIXED == TRUE){
BIntNo            <- ceiling((as.numeric(as.Date(paste(cutoff.day, cutoff.month, year(BDate), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1) / 7)
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- ceiling((as.numeric(as.Date(paste(cutoff.day, cutoff.month, (year(BDate[wrongyear]) + 1), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1) / 7)
} else {
BIntNo <- RealBIntNo
}
} else if (CINTERVAL == "M"){
Cmonth     <- month(CDate)
Cyear      <- year(CDate) - min(year(CDate))
CIntNo     <- Cmonth + 12 * Cyear
RealBIntNo <- month(BDate) + 12 * (year(BDate) - min(year(CDate)))
NewClim    <- data.frame("CIntNo" = CIntNo, "Xvar" = Xvar, "Xvar2" = Xvar2)
NewClim2   <- melt(NewClim, id = "CIntNo")
NewClim3   <- cast(NewClim2, CIntNo ~ variable, mean)
CIntNo     <- NewClim3$CIntNo
Xvar       <- NewClim3$Xvar
Xvar2      <- NewClim3$Xvar2
if (FIXED == TRUE){
BIntNo            <- cutoff.month + 12 * (year(BDate) - min(year(CDate)))
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- cutoff.month + 12 * (year(BDate[wrongyear]) + 1 - min(year(CDate)))
} else {
BIntNo <- RealBIntNo
}
}
}
return(list(CIntNo = CIntNo, BIntNo = BIntNo, Xvar = Xvar, Xvar2 = Xvar2))
}
microbenchmark(Cmatyears(Xvar = OffspringClimate$Temperature, CDate = OffspringClimate$Date, BDate = Offspring$Date, closest = 0, furthest = 1, FIXED = FALSE, CINTERVAL = "D", CMISSING = FALSE),
Cmatmatch(Xvar = OffspringClimate$Temperature, CDate = OffspringClimate$Date, BDate = Offspring$Date, closest = 0, furthest = 1, FIXED = FALSE, CINTERVAL = "D", CMISSING = FALSE),
Cmatin(Xvar = OffspringClimate$Temperature, CDate = OffspringClimate$Date, BDate = Offspring$Date, closest = 0, furthest = 1, FIXED = FALSE, CINTERVAL = "D", CMISSING = FALSE),
repeats = 10)
DateConverter <- function(BDate, CDate, Xvar, Xvar2 = NULL, CINTERVAL, FIXED,
cutoff.day, cutoff.month, cross = FALSE){
BDate  <- as.Date(BDate, format = "%d/%m/%Y") # Convert the date variables into the R date format
CDate2 <- seq(min(as.Date(CDate, format = "%d/%m/%Y")), max(as.Date(CDate, format = "%d/%m/%Y")), "days") # Convert the date variables into the R date format
CDate  <- as.Date(CDate, format = "%d/%m/%Y")
Xvar <- Xvar[match(CDate2, CDate)]
CIntNo     <- as.numeric(Dat2$ListDate) - min(as.numeric(Dat2$ListDate)) + 1   # atrribute daynumbers for both datafiles with first date in CLimateData set to CIntNo 1
RealBIntNo <- as.numeric(BDate) - min(as.numeric(Dat2$ListDate)) + 1
if (length(CIntNo) != length(unique(CIntNo))){
stop ("There are duplicate dayrecords in climate data")
}
if (CINTERVAL != "D" && CINTERVAL != "W" && CINTERVAL != "M"){
stop("CINTERVAL should be either D, W or M")
}
if(cross == FALSE){
if (CINTERVAL == "D"){
if (FIXED == TRUE){
BIntNo            <- as.numeric(as.Date(paste(cutoff.day, cutoff.month, year(BDate), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- (as.numeric(as.Date(paste(cutoff.day, cutoff.month, (year(BDate[wrongyear]) + 1), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1)
} else {
BIntNo <- RealBIntNo
}
} else if (CINTERVAL == "W"){
CIntNo     <- ceiling((as.numeric(CDate) - min(as.numeric(CDate)) + 1) / 7)   # atrribute weeknumbers for both datafiles with first week in CLimateData set to CIntNo 1
RealBIntNo <- ceiling((as.numeric(BDate) - min(as.numeric(CDate)) + 1) / 7)
NewClim    <- data.frame("CIntNo" = CIntNo, "Xvar" = Xvar)
NewClim2   <- melt(NewClim, id = "CIntNo")
NewClim3   <- cast(NewClim2, CIntNo~variable, mean)
CIntNo     <- NewClim3$CIntNo
Xvar       <- NewClim3$Xvar
if (FIXED == TRUE){
BIntNo            <- ceiling((as.numeric(as.Date(paste(cutoff.day, cutoff.month, year(BDate), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1) / 7)
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- ceiling((as.numeric(as.Date(paste(cutoff.day, cutoff.month, (year(BDate[wrongyear]) + 1), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1) / 7)
} else {
BIntNo <- RealBIntNo
}
} else if (CINTERVAL == "M"){
Cmonth     <- month(CDate)
Cyear      <- year(CDate) - min(year(CDate))
CIntNo     <- Cmonth + 12 * Cyear
RealBIntNo <- month(BDate) + 12 * (year(BDate) - min(year(CDate)))
NewClim    <- data.frame("CIntNo" = CIntNo, "Xvar" = Xvar)
NewClim2   <- melt(NewClim, id = "CIntNo")
NewClim3   <- cast(NewClim2, CIntNo~variable, mean)
CIntNo     <- NewClim3$CIntNo
Xvar       <- NewClim3$Xvar
if (FIXED == TRUE){
BIntNo            <- cutoff.month + 12 * (year(BDate) - min(year(CDate)))
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- cutoff.month + 12 * (year(BDate[wrongyear]) + 1 - min(year(CDate)))
} else {
BIntNo <- RealBIntNo
}
}
} else {
if (CINTERVAL == "D"){
if (FIXED == TRUE){
BIntNo            <- as.numeric(as.Date(paste(cutoff.day, cutoff.month, year(BDate), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- (as.numeric(as.Date(paste(cutoff.day, cutoff.month, (year(BDate[wrongyear]) + 1), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1)
} else {
BIntNo <- RealBIntNo
}
} else if (CINTERVAL == "W"){
CIntNo     <- ceiling((as.numeric(CDate) - min(as.numeric(CDate)) + 1) / 7)   # atrribute weeknumbers for both datafiles with first week in CLimateData set to CIntNo 1
RealBIntNo <- ceiling((as.numeric(BDate) - min(as.numeric(CDate)) + 1) / 7)
NewClim    <- data.frame("CIntNo" = CIntNo, "Xvar" = Xvar, "Xvar2" = Xvar2)
NewClim2   <- melt(NewClim, id = "CIntNo")
NewClim3   <- cast(NewClim2, CIntNo~variable, mean)
CIntNo     <- NewClim3$CIntNo
Xvar       <- NewClim3$Xvar
Xvar2      <- NewClim3$Xvar2
if (FIXED == TRUE){
BIntNo            <- ceiling((as.numeric(as.Date(paste(cutoff.day, cutoff.month, year(BDate), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1) / 7)
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- ceiling((as.numeric(as.Date(paste(cutoff.day, cutoff.month, (year(BDate[wrongyear]) + 1), sep = "-"), format = "%d-%m-%Y")) - min(as.numeric(CDate)) + 1) / 7)
} else {
BIntNo <- RealBIntNo
}
} else if (CINTERVAL == "M"){
Cmonth     <- month(CDate)
Cyear      <- year(CDate) - min(year(CDate))
CIntNo     <- Cmonth + 12 * Cyear
RealBIntNo <- month(BDate) + 12 * (year(BDate) - min(year(CDate)))
NewClim    <- data.frame("CIntNo" = CIntNo, "Xvar" = Xvar, "Xvar2" = Xvar2)
NewClim2   <- melt(NewClim, id = "CIntNo")
NewClim3   <- cast(NewClim2, CIntNo ~ variable, mean)
CIntNo     <- NewClim3$CIntNo
Xvar       <- NewClim3$Xvar
Xvar2      <- NewClim3$Xvar2
if (FIXED == TRUE){
BIntNo            <- cutoff.month + 12 * (year(BDate) - min(year(CDate)))
wrongyear         <- which(BIntNo < RealBIntNo)
BIntNo[wrongyear] <- cutoff.month + 12 * (year(BDate[wrongyear]) + 1 - min(year(CDate)))
} else {
BIntNo <- RealBIntNo
}
}
}
return(list(CIntNo = CIntNo, BIntNo = BIntNo, Xvar = Xvar, Xvar2 = Xvar2))
}
microbenchmark(Cmatyears(Xvar = OffspringClimate$Temperature, CDate = OffspringClimate$Date, BDate = Offspring$Date, closest = 0, furthest = 1, FIXED = FALSE, CINTERVAL = "D", CMISSING = FALSE),
Cmatmatch(Xvar = OffspringClimate$Temperature, CDate = OffspringClimate$Date, BDate = Offspring$Date, closest = 0, furthest = 1, FIXED = FALSE, CINTERVAL = "D", CMISSING = FALSE),
Cmatin(Xvar = OffspringClimate$Temperature, CDate = OffspringClimate$Date, BDate = Offspring$Date, closest = 0, furthest = 1, FIXED = FALSE, CINTERVAL = "D", CMISSING = FALSE),
repeats = 10)
#This will have a missing day for the first record on the CMatrix
OffspringClimate2 <- OffspringClimate[-1378,]
Cmatyears(Xvar = OffspringClimate$Temperature, CDate = OffspringClimate$Date, BDate = Offspring$Date, closest = 0, furthest = 1, FIXED = FALSE, CINTERVAL = "D", CMISSING = FALSE)
Cmatyears(Xvar = OffspringClimate2$Temperature, CDate = OffspringClimate2$Date, BDate = Offspring$Date, closest = 0, furthest = 1, FIXED = FALSE, CINTERVAL = "D", CMISSING = FALSE)
#When which has a missing year (i.e. year abscent completely) it returns integer(0) rather than NA. This causes a crash.
library(devtools)
devtools::test("climwin")
library(climwin)
library(devtools)
devtools::test("climwin")
library(climwin)
?climatewin
data(Mass)
data(MassClimate)
MassWin <- climatewin(Xvar = MassClimate$Temp, CDate = MassClimate$Date, BDate = Mass$Date,
baseline = lm(Mass$Mass ~ 1),
furthest = 100, closest = 0,
STAT = "mean", FUNC = "L",
FIXED = TRUE, cutoff.day = 20, cutoff.month = 5,
nrandom = 0, CMISSING = FALSE, CINTERVAL = "D")
library(climwin)
data(Mass)
data(MassClimate)
MassWin <- climatewin(Xvar = MassClimate$Temp, CDate = MassClimate$Date, BDate = Mass$Date,
baseline = lm(Mass$Mass ~ 1),
furthest = 100, closest = 0,
STAT = "mean", FUNC = "L",
FIXED = TRUE, cutoff.day = 20, cutoff.month = 5,
nrandom = 0, CMISSING = FALSE, CINTERVAL = "D")
head(MassClimate)
MassClimate[500:1000]
MassClimate[500:1000,]
MassClimate <- MassClimate[-869, ]
MassClimate[800:900, ]
MassWin <- climatewin(Xvar = MassClimate$Temp, CDate = MassClimate$Date, BDate = Mass$Date,
baseline = lm(Mass$Mass ~ 1),
furthest = 100, closest = 0,
STAT = "mean", FUNC = "L",
FIXED = TRUE, cutoff.day = 20, cutoff.month = 5,
nrandom = 0, CMISSING = FALSE, CINTERVAL = "D")
devtools::test("climwin")
?autowin
data(Mass)
data(MassClimate)
# Fit a single climate window using the datasets Mass and MassClimate.
single <- singlewin(Xvar = MassClimate$Temp, CDate = MassClimate$Date, BDate = Mass$Date,
baseline = lm(Mass$Mass ~ 1), furthest = 72, closest = 15,
STAT = "mean", FUNC = "L",
FIXED = TRUE, cutoff.day = 20, cutoff.month = 5,
CMISSING = FALSE, CINTERVAL = "D")
# Test the autocorrelation between the climate in this single window and other climate windows.
auto <- autowin(reference = single[[2]]$temporary,
Xvar  = MassClimate$Temp, CDate = MassClimate$Date, BDate = Mass$Date,
furthest = 365, closest = 0, STAT = "mean",
FIXED = TRUE, cutoff.day = 20, cutoff.month = 5,
CMISSING = FALSE, CINTERVAL = "D")
?singlewin
data(Mass)
data(MassClimate)
# Test for a fixed climate window, starting from 20th May
# Fit a climate window starting 72 days ago and ending 15 days ago
# Fit a linear term for the mean climate
# Fit climate windows at the resolution of days
single <- singlewin(Xvar = MassClimate$Temp, CDate = MassClimate$Date, BDate = Mass$Date,
baseline = lm(Mass ~ 1, data = Mass), furthest = 72, closest = 15,
STAT = "mean", FUNC = "L",
FIXED = TRUE, cutoff.day = 20, cutoff.month = 5,
CMISSING = FALSE, CINTERVAL = "D")
library(climwin)
?singlewin
data(Mass)
data(MassClimate)
# Test for a fixed climate window, starting from 20th May
# Fit a climate window starting 72 days ago and ending 15 days ago
# Fit a linear term for the mean climate
# Fit climate windows at the resolution of days
single <- singlewin(Xvar = MassClimate$Temp, CDate = MassClimate$Date, BDate = Mass$Date,
baseline = lm(Mass ~ 1, data = Mass), furthest = 72, closest = 15,
STAT = "mean", FUNC = "L",
FIXED = TRUE, cutoff.day = 20, cutoff.month = 5,
CMISSING = FALSE, CINTERVAL = "D")
devtools::test("climwin")
